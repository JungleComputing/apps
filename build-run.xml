<project
    name="run"
    default="run1"
    basedir=".">

    <description>
	Ibis application run target.

	Require prior definition of properties:
	ibis			location of ibis root

	Targets:

	run1	run the application as a parallel program,
		with a single instance, using TCP ibis.
		Set parameter:
		runjob		main class name and arguments
		java-args	flags for java
		ibis-run-args	flags for ibis-run

	run2	run the application as a parallel program,
		with two instances, using TCP ibis.
		Set parameter:
		runjob		main class name and arguments
		java-args	flags for java
		ibis-run-args	flags for ibis-run

	runseq	run the application as a sequential program.
		Set parameter:
		runjob		main class name and arguments
		java-args	flags for java
		ibis-run-args	flags for ibis-run

    </description>

    <property name="ibis-run-args" value=""/>
    <property name="java-args" value=""/>

    <target name="run2">
	<exec dir="${basedir}"
	      executable="${ibis}/bin/ibis-run"
	      vmlauncher="false"
	      spawn="true">
	      <arg line="-ns localhost -ns-port 4567 -hostno 1 -nhosts 2 ${ibis-run-args}"/>
	      <arg value="&quot;-Dibis.name=tcp&quot;"/>
	      <arg line="${java-args} ibis.util.Postpone 2 ${runjob}"/>
	</exec>
	<exec dir="${basedir}"
	      executable="${ibis}/bin/ibis-run"
	      timeout="500000"
	      failonerror="true"
	      vmlauncher="false">
	      <arg line="-ns localhost -ns-port 4567 -hostno 0 -nhosts 2 ${ibis-run-args}"/>
	      <arg value="&quot;-Dibis.name=tcp&quot;"/>
	      <arg line="${java-args} ${runjob}"/>
	</exec>
    </target>

    <target name="run1">
	<exec dir="${basedir}"
	      executable="${ibis}/bin/ibis-run"
	      timeout="500000"
	      failonerror="true"
	      vmlauncher="false">
	      <arg line="-ns localhost -ns-port 4567 -hostno 0 -nhosts 1 ${ibis-run-args}"/>
	      <arg value="&quot;-Dibis.name=tcp&quot;"/>
	      <arg line="${java-args} ${runjob}"/>
	</exec>
    </target>

    <target name="runseq">
	<exec dir="${basedir}"
	      executable="${ibis}/bin/ibis-run"
	      timeout="500000"
	      failonerror="true"
	      vmlauncher="false">
	      <arg line="${ibis-run-args} -- ${java-args} ${runjob}"/>
	</exec>
    </target>

    <target name="test-par"
	    depends="build"
	    description="Run a parallel test if the property 'test-par-run' is set">
	<if>
	    <isset property="test-par-run"/>
	    <then>
		<echo message="Running parallel test on two JVM instances"/>
		<if>
		    <isset property="test-par-java-args"/>
		    <then>
			<property name="jargs" value="${test-par-java-args}"/>
		    </then>
		    <else>
			<property name="jargs" value=""/>
		    </else>
		</if>
		<antcall target="run2">
		    <param name="runjob" value="${test-par-run}"/>
		    <param name="java-args" value="${jargs}"/>
		</antcall>
	    </then>
	</if>
    </target>

    <target name="test-seq"
	    depends="build"
	    description="Run a sequential test if the property 'test-seq-run' is set">
	<if>
	    <isset property="test-seq-run"/>
	    <then>
		<echo message="Running sequential test"/>
		<if>
		    <isset property="test-seq-java-args"/>
		    <then>
			<property name="jargs" value="${test-seq-java-args}"/>
		    </then>
		    <else>
			<property name="jargs" value=""/>
		    </else>
		</if>
		<antcall target="run1">
		    <param name="runjob" value="${test-seq-run}"/>
		    <param name="java-args" value="${jargs}"/>
		</antcall>
	    </then>
	</if>
    </target>

    <!-- Default test target, for if the application does not have one.
	 Does test-par as well as test-seq.
    -->
    <target name="test"
	    depends="test-seq,test-par">
    </target>

</project>
