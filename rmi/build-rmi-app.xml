<project
    name="rmi-app"
    default="build"
    basedir=".">

    <description>
	Ibis rmi application build.
    </description>

    <!--
	Optional property 'rmic-flags' can be set to pass extra flags
	    on to Ibisc.
    -->

    <property environment="env"/>
    <property name="rmi"         location="${env.RMI_HOME}"/>
    <property name="myclasspath" value="${env.CLASSPATH}"/>

    <property name="tmp"         value="tmp"/>
    <property name="src"         value="src"/>
    <property name="lib"         value="lib"/>

    <target name="set-classpath" unless="classpath.initialized">
	<path id="default.classpath">
	    <pathelement path="${tmp}"/>
	    <pathelement path="${user-classpath}"/>
	    <pathelement path="${myclasspath}"/>
	    <fileset dir="${rmi}/lib">
		<include name="*.jar"/>
	    </fileset>
	</path>
	<echo	message="Now set default.classpath to ${default.classpath}"
		level="verbose"/>
	<property name="classpath.initialized" value="true"/>
    </target>

    <target name="property-init"
	    depends="set-classpath">
    </target>

    <property name="java-args" value="" />

    <target name="set-ibis-implementation">

        <condition property="ibis-implementation" value="tcp">
            <not>
                <isset property="ibis-implementation" />
            </not>
        </condition>

        <condition property="define-ibis-implementation" value="&quot;-Dibis.implementation^=${ibis-implementation}&quot;">
            <os family="windows" />
        </condition>
        <condition property="define-ibis-implementation" value="-Dibis.implementation=${ibis-implementation}">
            <not>
                <isset property="define-ibis-implementation" />
            </not>
        </condition>
    </target>

    <target name="run2" depends="set-ibis-implementation">
        <exec dir="${basedir}" executable="${rmi}/bin/ibis-rmi-run" vmlauncher="false" spawn="true">
            <arg line="-Dibis.pool.size=2" />
            <arg line="-Dibis.pool.name=test-pool" />
            <arg line="-Dibis.server.address=localhost:8888" />
            <arg value="${define-ibis-implementation}" />
            <arg line="${java-args} ibis.util.Postpone 2 -o ant-test.out ${runjob}" />
	    <env key="CLASSPATH" path="${lib}/${application-name}.jar"/>
        </exec>
        <exec dir="${basedir}" executable="${rmi}/bin/ibis-rmi-run" timeout="500000" failonerror="true" vmlauncher="false">
            <arg line="-Dibis.pool.size=2" />
            <arg line="-Dibis.pool.name=test-pool" />
            <arg line="-Dibis.server.address=localhost:8888" />
            <arg value="${define-ibis-implementation}" />
            <arg line="${java-args} ${runjob}" />
	    <env key="CLASSPATH" path="${lib}/${application-name}.jar"/>
        </exec>
    </target>

    <target name="do-prun" depends="set-ibis-implementation">
        <condition property="prun-nprocs" value="2">
            <not>
                <isset property="prun-nprocs" />
            </not>
        </condition>
        <echo message="Running parallel test on ${prun-nprocs} nodes, ${ibis-implementation} Ibis" />

	<property name="ibis"        location="${env.IBIS_HOME}"/>

        <exec dir="${basedir}" executable="/usr/local/VU/reserve.sge/bin/prun" vmlauncher="false">
	    <arg value="COMMAND=${rmi}/bin/ibis-rmi-run" />
	    <arg value="CLASSPATH=${lib}/${application-name}.jar"/>
            <arg line="-1 ${ibis}/bin/ibis-prun ${prun-nprocs}" />
            <arg value="${define-ibis-implementation}" />
            <arg line="${java-args} ${runjob}" />
        </exec>
    </target>

    <target name="run1" depends="set-ibis-implementation">
        <exec dir="${basedir}" executable="${rmi}/bin/ibis-rmi-run" timeout="500000" failonerror="true" vmlauncher="false">
            <arg line="-Dibis.pool.size=1" />
            <arg line="-Dibis.pool.name=test-pool" />
            <arg line="-Dibis.server.address=localhost:8888" />
            <arg value="${define-ibis-implementation}" />
            <arg line="${java-args} ${runjob}" />
	    <env key="CLASSPATH" path="${lib}/${application-name}.jar"/>
        </exec>
    </target>

    <target name="runseq">
        <exec dir="${basedir}" executable="${rmi}/bin/ibis-rmi-run" timeout="500000" failonerror="true" vmlauncher="false">
            <arg line="${java-args} ${runjob}" />
	    <env key="CLASSPATH" path="${lib}/${application-name}.jar"/>
        </exec>
    </target>

    <target name="set-par-jargs-def" unless="test-par-java-args">
        <property name="jargs" value="" />
    </target>

    <target name="set-par-jargs-par" if="test-par-java-args">
        <property name="jargs" value="${test-par-java-args}" />
    </target>

    <target name="set-par-jargs" depends="set-par-jargs-def,set-par-jargs-par" />

    <target name="set-seq-jargs-def" unless="test-seq-java-args">
        <property name="jargs" value="" />
    </target>

    <target name="set-seq-jargs-seq" if="test-seq-java-args">
        <property name="jargs" value="${test-seq-java-args}" />
    </target>

    <target name="set-seq-jargs" depends="set-seq-jargs-def,set-seq-jargs-seq" />

    <target name="test-par" description="Run a parallel test if the property 'test-par-run' is set" depends="set-par-jargs" if="test-par-run">
        <echo message="Running parallel test on two JVM instances" />
        <antcall target="run2">
            <param name="runjob" value="${test-par-run}" />
            <param name="java-args" value="${jargs}" />
        </antcall>
        <echo message="Output of 2nd JVM" />
        <concat>
            <fileset dir="." includes="ant-test.out" />
        </concat>
    </target>

    <target name="test-prun" description="Run a parallel test with prun if the property 'test-par-run' is set" depends="jar,set-par-jargs" if="test-par-run">
        <antcall target="do-prun">
            <param name="runjob" value="${test-par-run}" />
            <param name="java-args" value="${jargs}" />
        </antcall>
    </target>

    <target name="test-seq" if="test-seq-run" depends="set-seq-jargs" description="Run a sequential test if the property 'test-seq-run' is set">
        <echo message="Running sequential test" />
        <antcall target="run1">
            <param name="runjob" value="${test-seq-run}" />
            <param name="java-args" value="${jargs}" />
        </antcall>
    </target>

    <!-- Default test target, for if the application does not have one.
	 Does test-par as well as test-seq.
    -->

    <target name="build-and-test" depends="jar, test-seq, test-par"/>

    <target name="test" unless="no-test" description="Build, run sequential test, run parallel test">
        <antcall inheritRefs="true" target="build-and-test" />
    </target>

    <target name="jar" depends="build" description="Build a Jar file for an application">
        <basename file="." property="application-name" />
	<jar destfile="${lib}/${application-name}.jar" basedir="${tmp}" includes="**/*.class">
        </jar>
        <delete dir="${tmp}" />
    </target>

    <target name="init" depends="property-init">
        <tstamp />
        <mkdir dir="${tmp}" />
        <mkdir dir="${lib}" />
    </target>

    <target name="compile" depends="clean,init"
	    description="Compile application without any bytecode rewriting">
	<javac destdir="${tmp}" debug="true" srcdir="${src}">
	    <classpath refid="default.classpath" />
	    <!--
	    <compilerarg value="-Xlint:unchecked"/>
	    -->
            <include name="**/*.java" />
        </javac>
    </target>

    <target name="clean" description="Clean up the build">
        <delete dir="${tmp}" />
        <delete dir="${lib}" />
        <delete file="ant-test.out" />
    </target>


    <property name="tmpdir" location="${tmp}"/>

    <target name="set-to-rmic-flags" if="rmic-flags">
	<property name="rmic-flags.value" value="${rmic-flags}"/>
    </target>

    <target name="set-def-rmic-flags" unless="rmic-flags">
	<property name="rmic-flags.value" value=""/>
    </target>

    <target name="set-rmic-flags"
	depends="set-to-rmic-flags,set-def-rmic-flags"/>

    <target name="rmic"
	    depends="set-rmic-flags">
	    <!-- Commented out; not toplevel.
	    description="Preprocess class files in the build tree for RMI"
	    -->
	<java   classname="ibis.compile.Ibisc"
		taskname="Ibisc"
		dir="${tmp}"
		failonerror="true"
		fork="true">
		<arg line="${rmic-flags.value} -rmi -rmi-java2ibis ."/>
	    <classpath refid="default.classpath"/>
	</java>
    </target>

    <target name="rmic-sun">
	    <!-- Commented out; not toplevel.
	    description="Preprocess class files in the build tree for SUN RMI"
	    -->

	<path id="all-classes">
	    <fileset dir="${tmpdir}">
		<include name="**/*.class"/>
	    </fileset>
	</path>
	<pathconvert pathsep=" " property="classes.all" refid="all-classes">
	    <map from="${tmpdir}${file.separator}" to=""/>
	</pathconvert>

	<echo message="${classes.all}" file="${tmp}/-RMIC-Classes"/>
	<replace file="${tmp}/-RMIC-Classes" token=".class" value=""/>
	<replace file="${tmp}/-RMIC-Classes" token="${file.separator}" value="."/>
	<loadfile
		property="rmic-classes"
		srcFile="${tmp}/-RMIC-Classes">
	</loadfile>

	<echo   level="debug"
		message="All classes to be inspected: ${rmic-classes}"/>
	<echo   level="debug"
		message="Run frontend.rmi.Rmic -n -java over all classes under ${tmp}${file.separator}"/>
	<java   classname="ibis.rmi.impl.frontend.Rmic"
		taskname="rmic locator"
		dir="${tmpdir}"
		failonerror="true"
		fork="true"
		output="${tmp}/-REMOTE-Classes">
	    <arg line="-n -java ${rmic-classes}"/>
	    <classpath refid="default.classpath"/>
	</java>
	<loadfile
		property="remote.classes"
		srcFile="${tmp}/-REMOTE-Classes"/>
	<echo   level="debug"
		message="Now run sun.rmic over '${remote.classes}'"/>
	<rmic   base="${tmp}"
		includes="${remote.classes}">
	    <classpath refid="default.classpath"/>
	</rmic>
    </target>

    <target name="build"
	    depends="compile, rmic"
	    description="Compile RMI application for Ibis RMI">
    </target>

    <target name="build-sun"
	    depends="compile, rmic-sun"
	    description="Compile RMI application for Sun RMI">
    </target>

</project>
